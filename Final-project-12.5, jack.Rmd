---
title: "Biodiversity in National Parks"
author: "Emily Mynar, Jack McCormick, & Pierre Beaurang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE,
                      #fig.width=8, 
                      #fig.height=5,
                      warning = F,
                      message = F)


# Load packages
pacman::p_load(dplyr, ggplot2, tidyverse, ggthemes, maps, ggrepel, rpart, rpart.plot, FNN, skimr, broom, GGally)

# Set default theme
theme_set(theme_bw())

# Read in files
parks <- read.csv('parks.csv') |>
  janitor::clean_names()

species <- read.csv('species.csv') |>
  janitor::clean_names() 

tibble(species)
tibble(parks)
```
\newpage

### Data Cleaning

Our data comes from two data sets:

1) **parks:** contains general information (size, latitude, longitude, etc.) about each National Park in the United States. This will be largely supplemental, but provides important contextual information we will use later

2) **species:** contains a record of each species recorded in a certain National Park. This will be our main data set.

Along with the true taxonomic groupings of order and family, the data also includes a *'category'* variable, which is not equivalent to any true taxonomic grouping, but instead consists of informal groupings which are recognizable to the layperson. Let's take a look at them now, since we'll be using these groups for much of our analysis.
```{r categories}

# Display species categories
categories <-
  species |>
  group_by(category) |>
  summarize(category_count = n()) |>
  select(category)

tibble(categories)
```
14 categories, but for our purposes, we only care about the **animal** diversity of these parks. As such, we will go ahead and remove *algae*, *fungi*, *Nonvascular plants*, and *Vascular plants*.  

As we began analyzing our data, we realized that reporting of insects was inconsistent, and skewed our data heavily in the wrong direction. As such, we decided to limit our scope to **vertebrate** biodiversity rather than animal diversity. To accomplish this, we removed the *insect* group which was causing problems, as well as all other invertebrate categories *Invertebrate*, *Crab/Lobster/Shrimp*, *Slug/Snail* and *Spider/Scorpion*

We'll also implement a handful of other changes to our data: removing record status and seasonality, which are not useful for our driving question, adding a genus category, which is taken from the scientific name, and shortening the names of parks to remove the suffix for clarity.

```{r data cleaning}

species_clean <-
  species |>
  # Remove record status and seasonality
  select(-record_status, -seasonality, -x) |>
  # Filter non-animal species,
  # Filter invertebrate species
  filter(!category %in% c('Algae', 'Fungi', 'Nonvascular Plant', 'Vascular Plant', 'Insect', 'Invertebrate', 'Crab/Lobster/Shrimp', 'Slug/Snail', 'Spider/Scorpion')) |>
  # Add genus column
  mutate(genus = str_split(scientific_name, " ", simplify = T)[ , 1]) |>
  # Reorder columns
  relocate(genus, .before = scientific_name) |>
  # Make park names shorter
  mutate(park_name = str_remove(park_name, 'National Parks'),
         park_name = str_remove(park_name, 'National Park'),
         park_name = str_remove(park_name, 'and Preserve'))

tibble(species_clean)


parks_clean <-
  parks |>
  # Make park names shorter
  mutate(park_name = str_remove(park_name, 'National Parks'),
         park_name = str_remove(park_name, 'National Park'),
         park_name = str_remove(park_name, 'and Preserve'))

tibble(parks_clean)
```
Lastly, we'll combine the two data sets and remove the park code.

We have decided to restrict our data to the contiguous United States, for a number of reasons. Alaska and Hawaii have populations that are so different from the rest of the country that they are hardly comparable. Removing them makes our data far less complex, as it removes species that are found nowhere else in the country. It also serves the secondary purpose of making the data mapping easier. 

```{r combined dataset}
species_park <-
  species_clean |>
  # Add park info to species dataset
  left_join(y = parks_clean, by = 'park_name') |>
  # Remove park code
  select(-park_code) |>
  # Remove parks in Alaska or Hawaii for mapping purposes
  filter(!state %in% c('AK', 'HI')) 
  
tibble(species_park)
```

Here are our updated species, categories, which will be used throughout the rest of the analysis. 

```{r updated categories}

# Display updated species categories
categories_clean <-
  species_clean |>
  group_by(category) |>
  summarize(category_count = n()) |>
  select(category)

tibble(categories_clean)

```
\newpage

### Data Analysis

Because our categories are not true taxonomic groupings, we need some context to the diversity within each. Lets examine orders first.

```{r overall taxanomic categories proportion}

category_prop <-
  
  species_clean |>
  group_by(category) |>
  summarize(number_cat = n()) |>
  mutate(number_tot = sum(number_cat),
         prop = number_cat/number_tot) |>
  select(category, prop)

category_prop |>
  
  ggplot(mapping = aes(
    y = prop,
    x = "",
    fill = category
  )) +

  geom_col(position = "fill",
           color = "black") +
  
  labs(x = NULL,
       y = "Proportion by Category",
       fill = "Category",
       title = "Proportion of Each Taxanomic Category")

  species_clean |>
  group_by(category, order) |>
  summarize(number_ord = n()) |>
  mutate(number_tot = sum(number_ord),
         prop = number_ord/number_tot) |>
  select(category, order, prop) |>
  
  ggplot(mapping = aes(
    x = prop,
    y = "",
    fill = order
  )) +
    
    geom_col(position = "fill",
           color = "black") +
    labs(y = NULL,
       x = "Proportion by Order",
       fill = "Category",
       title = "Proportion of Each Order") +
    
    facet_wrap(facets = '~category') +
    
    theme(legend.position = 'none')


```
\newline

As seen above, the vast majority of species observed fall into the **bird** categories. This can be explained by a few different hypotheses:

1) Because we removed seasonality, we are looking at species spotted in the park at any time of year, including species that are strictly migratory. Due to their migratory nature, the average bird species is often has a wider range of observation than that of an equivalent reptile, amphibian or mammal. 

2) Additionally, due to a variety of factors, birds are often have more comprehensive records than any other group. The MAPS program, created by the Institute for Bird Populations has gone a long way to creating distribution patterns across the United States, and the role of citizen science, on programs like eBird or iNaturalist create lists of observed species without the need for a monitoring program run by the park. 

3) Birds naturally have a high diversity, and occur across ecosystems. As such, every park is likely to have birds present, while fish, amphibians, reptiles, and mammals are far more restricted to certain habitats. 

```{r species by park}

ggplot(data = species_park |> group_by(park_name),
       mapping = aes(x = fct_infreq(park_name))) +
  
  geom_bar(fill = 'deepskyblue3') +
  
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 1,
                                   size = 7),
        plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold'),
        axis.title = element_text(size = 10)) +
  
  labs(x = 'Park name',
       y = 'Number of species',
       fill = 'Category',
       title = 'Number of species in each park') +
  
  scale_y_continuous(expand = c(0,0, 0.05, 0)) 

```
\newline

Deciding on conservation priorities requires the consideration of many different factors. For our purposes, we would argue that the biodiversity of a region is the most important factor. What method should be used to calculate this amorphous idea of 'biodiversity' is a topic of some debate. For our purposes, we have chosen a **raw species richness.** 

As can be seen in the graph above and table below, the parks with the greatest raw species richness are **Biscayne,** **Redwoods,** & **Everglades**. The parks with the lowest are **Mt. Rainier**, **Pinnacles** and **Black Canyon of the Gunnison**

```{r species richness order}

species_per_park <-
  species_park |>
  group_by(park_name, latitude, longitude, state, acres) |>
  summarise(num_species = n()) |>
  arrange(desc(num_species))

tibble(species_per_park)

park_order <-
  species_per_park$park_name


```
However, raw number of species does not tell a manager the whole picture. Certain species require more help than others. If the national parks service was concerned with protection endangered species, certain parks may be more worth investing in than others. 

```{r endangered species by park}
#isolating endangered species
endangered_species <-
  species_park |>
  filter(conservation_status != "")

ggplot(data = endangered_species |> group_by(park_name),
       mapping = aes(x = fct_infreq(park_name))) +
  
  geom_bar(fill = 'deepskyblue3') +
  
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 1,
                                   size = 7),
        plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold'),
        axis.title = element_text(size = 10)) +
  
  labs(x = 'Park name',
       y = 'Number of species',
       fill = 'Category',
       title = 'Threatened Species per park') +
  
  scale_y_continuous(expand = c(0,0, 0.05, 0)) 



```
\newline

Here we can see that the parks with the highest number of species listed as a 'species of concern' or worse by the National Parks are **Death Valley,** **Redwoods,** and the **Grand Canyon.** 

In contrast, **Congaree** has the lowest number of endangered species.

```{r endangered species richness order}
endangered_species_per_park <-
  endangered_species |>
  group_by(park_name, latitude, longitude, state, acres) |>
  summarise(num_species = n()) |>
  arrange(desc(num_species))

tibble(endangered_species_per_park)

endangered_order <-
  endangered_species_per_park$park_name


```
The total number of endangered species is important for management consideration, but these ecosystems may just have a large gross number of species. However, it may be worth focusing on ecosystems with a large **proportion of endangered species**.

There are two theories behind why an ecosystem has many endangered species:
1) Some quality of the environment attracts species with specific habitat requirements, which are more likely to become endangered. 

2) The national park is the last remnant of an ecosystem that used to be far more prevalent, and the species within became endangered as the ecosystem did. 

Either way, an organization considered with preserving biodiversity would get more 'bang for their buck' if they put their attention on these ecosystems. 

Under these criteria, the parks that should be focused on are *Pinnacles,* *The Petrified Forest*, and *Sequoia*. *Biscayne,* *The Everglades*, and *The Dry Tortugas*, on the other hand, consist of ecosystems primarily composed of non-threatened species. 

```{r Proportion Endangered Species Per Park}

prop <- left_join(species_per_park, endangered_species_per_park, by = "park_name")

prop |>
  ungroup() |>
  mutate(proportion_endangered = (num_species.y / num_species.x)) |>
  arrange(desc(proportion_endangered)) -> proportion_endangered

tibble(proportion_endangered)

proportion_order <-
  proportion_endangered$park_name
  


```
Lastly, to provide some context to the previous data points, the following graph shows the taxonomic categories present in each park. 

The most important insight to be gleaned from this data is the *'Biscayne Question'.* This park has simultaneously the highest number of species and the lowest proportion of endangered species (the same paradox is true of Everglades park, to a lesser extent). 

However, the answer becomes present here. According to the IUCN, bony fishes are the invertebrate group with the lowest proportion of endangered species. The parks in our data set that have a large number of fish (Biscayne, Everglades, Dry Tortugas, etc.) are likely to have a low proportion of endangered species.

As such, if the National Park Service is concerned with managing for *raw biodiversity*, we would advocate for an *increased focus on largely aquatic parks*. If they are more concerned with *protecting endangered species* we could recommend an approach that *disregards largely aquatic parks in favor of others*. 

Of course, the reality is not black and white, and this study ignores other factors that could potentially swing the recommendation in a different direction. No management plan is complete when only one facet of the problem is included. This is simply our recommendation based on the information at hand. 


```{r taxonomic categories by park}

categories_by_park <-
  species_park |>
  group_by(park_name, category) |>
  summarise(cat_sum = n())

ggplot(data = categories_by_park,
       mapping = aes(x = factor(park_name,
                                levels = park_order))) +
  
  geom_col(mapping = aes(y = cat_sum,
                         fill = category),
           position = 'stack') +
  
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 1,
                                   size = 7),
        plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold'),
        axis.title = element_text(size = 10)) +
  
  labs(x = 'Park name',
       y = 'Number of species',
       fill = 'Category',
       title = 'Number of species in each park by category') +
  
  scale_y_continuous(expand = c(0,0, 0.05, 0)) 



# Same plot but by proportion
ggplot(data = categories_by_park,
       mapping = aes(x = factor(park_name,
                                 levels = park_order),
                     y = cat_sum,
                     fill = category)) +
  
  geom_col(position = 'fill') +
  
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 1,
                                   size = 7),
        plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold'),
        axis.title = element_text(size = 10)) +
  
  labs(x = 'Park name',
       y = 'Proportion of species',
       fill = 'Category',
       title = 'Proportion of species in each park by category') +
  
  scale_y_continuous(labels = scales::percent,
                     expand = c(0,0)) 
  
  

  

```
\newpage

### Mapping
We have created four maps to illustrate certain relationships between the data.

In all maps, the color of the point represents the state the park lies within.


```{r map outline}
map_outline <-
  ggplot(data = map_data(map = 'state'),
         mapping = aes(x = long,
                       y = lat,
                       group = group)) +
  
  geom_polygon(fill = 'white',
               color = 'grey30') +
  
  theme_map() +
  
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  
  scale_x_continuous(expand = c(0,0)) +
  
  scale_y_continuous(expand = c(0,0))

```

Map 1:

In this map, we have used the size of the point to represent the *gross species richness*. 

```{r species richness map}
 richness_map <-
  
  map_outline +
  
  geom_point(data = species_per_park,
           mapping = aes(x = longitude,
                        y = latitude,
                       group = park_name,
                       size = num_species,
                       color = state)) +
  
  geom_text_repel(data = species_per_park,
            mapping = aes(x = longitude,
                          y = latitude,
                          group = park_name,
                          label = park_name),
            hjust = 0.1,
            size = 1.8,
            fontface= 'bold',
            max.overlaps = 15) +
  
  labs(title = 'Species richness by park',
       size = 'Number of species') +
  
  guides(color = F) +
  
  theme(legend.position = 'bottom',
        legend.direction = 'horizontal',
        legend.box.background = element_rect(color = 'black'),
        plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold'))
  
  
richness_map
```
\newline

Map 2:

In this map, we have used the size of the point to represent the *total endangered species*. 

```{r endangered species map by park}
endangered_map <-
  
  map_outline +
  
  geom_point(data = endangered_species_per_park,
           mapping = aes(x = longitude,
                        y = latitude,
                       group = park_name,
                       size = num_species,
                       color = state)) +
  
  geom_text_repel(data = endangered_species_per_park,
            mapping = aes(x = longitude,
                          y = latitude,
                          group = park_name,
                          label = park_name),
            hjust = 0.1,
            size = 1.8,
            fontface= 'bold',
            max.overlaps = 15) +
  
  labs(title = 'Number of endangered species by park',
       size = 'Number of species') +
  
  guides(color = F) +
  
  theme(legend.position = 'bottom',
        legend.direction = 'horizontal',
        legend.box.background = element_rect(color = 'black'),
        plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold'))
  
  
endangered_map

```
\newline

Map 3:

In this map, we have used the size of the point to represent the *proportion of species that are threatened or endangered*.

```{r proportion endangered map}

proportion_map <-
  
  map_outline +
  
  geom_point(data = proportion_endangered,
           mapping = aes(x = longitude.x,
                        y = latitude.x,
                       group = park_name,
                       size = proportion_endangered,
                       color = state.x)) +
  
  geom_text_repel(data = proportion_endangered,
            mapping = aes(x = longitude.x,
                          y = latitude.x,
                          group = park_name,
                          label = park_name),
            hjust = 0.1,
            size = 1.8,
            fontface= 'bold',
            max.overlaps = 15) +
  
  
  labs(title = 'Proportion threatened species by park',
       size = 'Proportion of species that are threatened or endangered') +
  
  guides(color = F) +
  
  theme(legend.position = 'bottom',
        legend.direction = 'horizontal',
        legend.box.background = element_rect(color = 'black'),
        plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold'))

  
  
proportion_map

```
\newline

Map 4:

In our final map, we have used the size of the point to represent the *total endangered species*.

We will use the size of parks and the number of species in the next segment.


```{r park size map}
richness_map <-
  
  map_outline +
  
  geom_point(data = species_per_park,
           mapping = aes(x = longitude,
                        y = latitude,
                       group = park_name,
                       size = acres,
                       color = state)) +
  
  geom_text_repel(data = species_per_park,
            mapping = aes(x = longitude,
                          y = latitude,
                          group = park_name,
                          label = park_name),
            hjust = 0.1,
            size = 1.8,
            fontface= 'bold',
            max.overlaps = 15) +
  
  scale_size(breaks = seq(from = 100000, to = 2500000, by = 200000)) +
  
  labs(title = 'Park size',
       size = 'Acreage') +
  
  guides(color = F) +
  
  theme(legend.position = 'bottom',
        legend.direction = 'horizontal',
        legend.box.background = element_rect(color = 'black'),
        plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold'))
  
  
richness_map
```
\newpage

### Machine Learning
Before we begin with our machine learning segment, we will primarily examine the relationship between park size and biodiversity. This analysis will provide the National Park Service with an invaluable data point. A larger park will require more funding, manpower, and work. If it is assumed that larger park = high biodiversity, the National Park Service will assign the most intensive management plans to the largest parks. However, using machine learning, we can devise a method that will determine the amount of effort to be put into a park based on the relationship between park size and biodiversity.

```{r scatter plot of size vs richness}
# very much in progress duh
ggplot(data = species_per_park,
       mapping = aes(x = acres,
                     y = num_species)) +
  
  geom_point(color = 'deepskyblue3') +
  
  geom_smooth(
    method = "loess",
    se = F,
    formula = y ~ x
  )
  
  labs(x = 'Size (acres)',
       y = 'Number of species',
       title = 'Park size vs. number of distinct species') +
  
  theme(plot.title = element_text(size = 12,
                                  hjust = 0.5,
                                  face = 'bold')) +
  
  scale_x_continuous(labels = scales::comma) 
  
  

```
\newline

The very first thing to be done is to determine if this relationship actually exists. To do this, we will construct a correlation matrix of the variables currently used.

```{r size richness correlation}

GGally::ggcorr(
  data = species_per_park,
  low = "red3",
  mid = "white",
  high = "blue3",
  label = T,
  label_round = 2
  
)
```
\newline

As we can see, there is a positive correlation between the number of species and the size of the park. Knowing this, we can forge ahead with our machine learning and examine this relationship in detail. 

regression tree

```{r regression tree}

species_and_acres <-
  species_per_park |>
  ungroup() |>
  select(acres, num_species)

species_tree_full <-
  rpart(
    formula = num_species ~ acres,
    data = species_and_acres,
    method = "anova",
    minsplit = 2,
    minbucket = 1,
    cp = -1
  )

species_tree_full$cptable |>
  data.frame()

```
```{r pruning}
plotcp(species_tree_full)

species_tree_full$cptable |>
  data.frame() |>
  slice_min(xerror, n = 1, with_ties = F) |>
  mutate(xerror_cutoff = xerror + xstd) |>
  pull(xerror_cutoff) ->
  xcutoff

species_tree_full$cptable |>
  data.frame() |>
  filter(xerror < xcutoff) |>
  slice(1) |>
  pull(CP) ->
  
  cp_value

c("xcutoff" = xcutoff,
  "CP value" = cp_value)

species_tree_pruned <-
  prune(tree = species_tree_full,
      cp = cp_value)

species_tree_pruned

```

```{r visualizing the pruned tree}
rpart.plot(species_tree_pruned,
           digits = 4,
           fallen.leaves = TRUE,
           type = 5,
           box.palette = 'BlGnYl',
           shadow.col = "gray")


```

KNN Regression

```{r KNN Regression}

# creating min-max normalization function
normalize <- function(x){
  return((x - min(x)) / (max(x) - min(x)))
}

#  normalizing the species data:
num_species_norm <- 
  species_and_acres |>
  select(-num_species) |>
  mutate(across(.cols = acres,
                .fns = normalize))


standardize <- function(x){
  return((x - mean(x)) / sd(x))
}

num_species_stan <- 
  species_and_acres |>
    select(-num_species) |>
  mutate(across(.cols = acres,
                .fns = standardize))

```

```{r knn_reg}

knn.reg(
  train = num_species_norm,
  y = species_and_acres$num_species,
  k = 5
) ->
  species_knn_5

tibble(y = species_and_acres$num_species,
       y_hat = species_knn_5$pred,
       residuals = y - y_hat) ->
  species_df

```


```{r fit stats}

species_df |>
  summarize(
    R2 = 1 - sum((y - y_hat)^2)/sum((y - mean(y))^2), 
    MAE = (y - y_hat) |> abs() |> mean(), #mean average error to find how off our guesses are, on average
    MAE_mean = (y - mean(y)) |> abs() |> mean(),
    MAER = 1 - MAE/MAE_mean
  )

```

``` {r k_norm}
k <- 1:46

fit_stats_norm <-
  tibble(k = k,
         R2 = rep(-1, length(k)),
         MAE = rep(-1, length(k)))

for (i in 1:length(k)){
  loop_knn <-
    knn.reg(
      train = num_species_norm,
      y = species_and_acres$num_species,
      k = k[i]
      ) 
  
  fit_stats_norm[i, "R2"] <- loop_knn$R2Pred
  fit_stats_norm[i, "MAE"] <- (species_and_acres$num_species - loop_knn$pred) |> abs() |> mean()
  
}

fit_stats_norm
```



```{r k_stan}
k <- 1:46

fit_stats_stan <-
  tibble(k = k,
         R2 = rep(-1, length(k)),
         MAE = rep(-1, length(k)))

for (i in 1:length(k)){
  loop_knn <-
    knn.reg(
      train = num_species_stan,
      y = species_and_acres$num_species,
      k = k[i]
      ) 
  
  fit_stats_stan[i, "R2"] <- loop_knn$R2Pred
  fit_stats_stan[i, "MAE"] <- (species_and_acres$num_species - loop_knn$pred) |> abs() |> mean()
  
}

fit_stats_stan


for (i in 1:10){
  print(i)
}

```

```{r plotting}

fit_stats_norm |>
  pivot_longer(
    cols = R2:MAE,
    names_to = "fit_stat",
    values_to = "fit"
  ) |>
  
  ggplot(mapping = aes(x = k,
                       y = fit,
                       color = fit_stat)) +
  
  geom_line(show.legend = F) +
  
  facet_wrap(facets = ~ fit_stat,
             scales = "free_y",
             ncol = 1)

fit_stats_stan |>
  pivot_longer(
    cols = R2:MAE,
    names_to = "fit_stat",
    values_to = "fit"
  ) |>
  
  ggplot(mapping = aes(x = k,
                       y = fit,
                       color = fit_stat)) +
  
  geom_line(show.legend = F) +
  
  facet_wrap(facets = ~ fit_stat,
             scales = "free_y",
             ncol = 1)

```

linear regression

```{r model_estimates}

lm(
  formula = num_species ~ acres,
  data = species_and_acres
) ->
  
  species_lm

summary(species_lm)


```

```{r tidy function}

species_estimates <-
  tidy(species_lm)

species_estimates |>
  mutate(across(.cols = where(is.numeric),
                .fns = round,
                digits = 3))
```

```{r fit_stats}

glance(species_lm)

MAE <- function(actual, predicted){
  mae <- abs(actual - predicted) |> mean()
  mae_red <- 1 - mae/mean(abs(actual - mean(actual)))
  return(list(mae = mae,
              reduction = mae_red))
}

MAE(actual = species_and_acres$num_species,
    predicted = species_lm$fit)

parks_clean_fit_stats <-
  augment_columns(x = species_lm,
                  data = species_and_acres)

parks_clean_fit_stats |>
  select(acres, num_species, .fitted, .resid) |>
  summarize(
    R2 = cor(num_species, .fitted)^2,
    MAE = MAE(actual = num_species,
              predicted = .fitted)$mae,
    Reduction = MAE(actual = num_species,
              predicted = .fitted)$reduction
  )



```

